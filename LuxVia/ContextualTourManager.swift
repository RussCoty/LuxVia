import UIKit

/// A tour system that can highlight specific UI elements and provide contextual guidance
class ContextualTourManager {
    static let shared = ContextualTourManager()
    
    private init() {}
    
    private weak var currentTourWindow: UIWindow?
    private var currentTourStep = 0
    private var tourSteps: [ContextualTourStep] = []
    private var onTourComplete: (() -> Void)?
    
    /// Start a contextual tour with specific steps
    func startTour(steps: [ContextualTourStep], completion: (() -> Void)? = nil) {
        guard !steps.isEmpty else { return }
        
        self.tourSteps = steps
        self.currentTourStep = 0
        self.onTourComplete = completion
        
        showCurrentStep()
    }
    
    /// Stop the current tour
    func stopTour() {
        hideTourWindow()
        tourSteps = []
        currentTourStep = 0
        onTourComplete = nil
    }
    
    private func showCurrentStep() {
        guard currentTourStep < tourSteps.count else {
            completeTour()
            return
        }
        
        let step = tourSteps[currentTourStep]
        showTourStep(step)
    }
    
    private func showTourStep(_ step: ContextualTourStep) {
        hideTourWindow()
        
        // Create overlay window
        let window = UIWindow(frame: UIScreen.main.bounds)
        window.windowLevel = .alert
        window.backgroundColor = UIColor.clear
        window.isHidden = false
        
        let overlayVC = ContextualTourOverlayViewController(step: step) { [weak self] in
            self?.nextStep()\n        }\n        \n        window.rootViewController = overlayVC\n        currentTourWindow = window\n    }\n    \n    private func nextStep() {\n        currentTourStep += 1\n        showCurrentStep()\n    }\n    \n    private func completeTour() {\n        hideTourWindow()\n        onTourComplete?()\n        tourSteps = []\n        currentTourStep = 0\n        onTourComplete = nil\n    }\n    \n    private func hideTourWindow() {\n        currentTourWindow?.isHidden = true\n        currentTourWindow = nil\n    }\n}\n\n/// Represents a single step in the contextual tour\nstruct ContextualTourStep {\n    let title: String\n    let description: String\n    let targetView: UIView?\n    let position: TooltipPosition\n    let imageName: String?\n    \n    enum TooltipPosition {\n        case top, bottom, left, right, center\n    }\n}\n\n/// View controller for the tour overlay\nclass ContextualTourOverlayViewController: UIViewController {\n    private let step: ContextualTourStep\n    private let onNext: () -> Void\n    \n    private let overlayView = UIView()\n    private let tooltipContainer = UIView()\n    private let titleLabel = UILabel()\n    private let descriptionLabel = UILabel()\n    private let nextButton = UIButton(type: .system)\n    private let skipButton = UIButton(type: .system)\n    private let imageView = UIImageView()\n    \n    init(step: ContextualTourStep, onNext: @escaping () -> Void) {\n        self.step = step\n        self.onNext = onNext\n        super.init(nibName: nil, bundle: nil)\n    }\n    \n    required init?(coder: NSCoder) {\n        fatalError(\"init(coder:) has not been implemented\")\n    }\n    \n    override func viewDidLoad() {\n        super.viewDidLoad()\n        setupOverlay()\n        setupTooltip()\n        positionTooltip()\n        \n        // Animate in\n        view.alpha = 0\n        UIView.animate(withDuration: 0.3) {\n            self.view.alpha = 1\n        }\n    }\n    \n    private func setupOverlay() {\n        view.backgroundColor = UIColor.black.withAlphaComponent(0.7)\n        \n        // Create spotlight effect if there's a target view\n        if let targetView = step.targetView {\n            createSpotlight(for: targetView)\n        }\n        \n        // Add tap to dismiss\n        let tapGesture = UITapGestureRecognizer(target: self, action: #selector(overlayTapped))\n        view.addGestureRecognizer(tapGesture)\n    }\n    \n    private func createSpotlight(for targetView: UIView) {\n        guard let window = view.window else { return }\n        \n        // Convert target view frame to window coordinates\n        let targetFrame = targetView.convert(targetView.bounds, to: window)\n        \n        // Create a path that covers the entire screen\n        let path = UIBezierPath(rect: view.bounds)\n        \n        // Create a spotlight hole\n        let spotlightPath = UIBezierPath(roundedRect: targetFrame.insetBy(dx: -8, dy: -8), cornerRadius: 8)\n        path.append(spotlightPath.reversing())\n        \n        // Create shape layer with the path\n        let shapeLayer = CAShapeLayer()\n        shapeLayer.path = path.cgPath\n        shapeLayer.fillRule = .evenOdd\n        \n        overlayView.backgroundColor = UIColor.black.withAlphaComponent(0.7)\n        overlayView.layer.mask = shapeLayer\n        overlayView.translatesAutoresizingMaskIntoConstraints = false\n        \n        view.addSubview(overlayView)\n        NSLayoutConstraint.activate([\n            overlayView.topAnchor.constraint(equalTo: view.topAnchor),\n            overlayView.leadingAnchor.constraint(equalTo: view.leadingAnchor),\n            overlayView.trailingAnchor.constraint(equalTo: view.trailingAnchor),\n            overlayView.bottomAnchor.constraint(equalTo: view.bottomAnchor)\n        ])\n    }\n    \n    private func setupTooltip() {\n        // Container\n        tooltipContainer.backgroundColor = .systemBackground\n        tooltipContainer.layer.cornerRadius = 12\n        tooltipContainer.layer.shadowColor = UIColor.black.cgColor\n        tooltipContainer.layer.shadowOpacity = 0.3\n        tooltipContainer.layer.shadowOffset = CGSize(width: 0, height: 4)\n        tooltipContainer.layer.shadowRadius = 8\n        tooltipContainer.translatesAutoresizingMaskIntoConstraints = false\n        view.addSubview(tooltipContainer)\n        \n        // Image\n        if let imageName = step.imageName {\n            imageView.image = UIImage(systemName: imageName)\n            imageView.tintColor = .systemBlue\n            imageView.contentMode = .scaleAspectFit\n            imageView.translatesAutoresizingMaskIntoConstraints = false\n            tooltipContainer.addSubview(imageView)\n        }\n        \n        // Title\n        titleLabel.text = step.title\n        titleLabel.font = UIFont.boldSystemFont(ofSize: 18)\n        titleLabel.textColor = .label\n        titleLabel.numberOfLines = 0\n        titleLabel.textAlignment = .center\n        titleLabel.translatesAutoresizingMaskIntoConstraints = false\n        tooltipContainer.addSubview(titleLabel)\n        \n        // Description\n        descriptionLabel.text = step.description\n        descriptionLabel.font = UIFont.systemFont(ofSize: 14)\n        descriptionLabel.textColor = .secondaryLabel\n        descriptionLabel.numberOfLines = 0\n        descriptionLabel.textAlignment = .center\n        descriptionLabel.translatesAutoresizingMaskIntoConstraints = false\n        tooltipContainer.addSubview(descriptionLabel)\n        \n        // Buttons\n        nextButton.setTitle(\"Got it!\", for: .normal)\n        nextButton.backgroundColor = .systemBlue\n        nextButton.setTitleColor(.white, for: .normal)\n        nextButton.layer.cornerRadius = 8\n        nextButton.titleLabel?.font = UIFont.boldSystemFont(ofSize: 16)\n        nextButton.translatesAutoresizingMaskIntoConstraints = false\n        nextButton.addTarget(self, action: #selector(nextTapped), for: .touchUpInside)\n        tooltipContainer.addSubview(nextButton)\n        \n        skipButton.setTitle(\"Skip Tour\", for: .normal)\n        skipButton.setTitleColor(.secondaryLabel, for: .normal)\n        skipButton.titleLabel?.font = UIFont.systemFont(ofSize: 14)\n        skipButton.translatesAutoresizingMaskIntoConstraints = false\n        skipButton.addTarget(self, action: #selector(skipTapped), for: .touchUpInside)\n        tooltipContainer.addSubview(skipButton)\n        \n        setupTooltipConstraints()\n    }\n    \n    private func setupTooltipConstraints() {\n        var constraints: [NSLayoutConstraint] = [\n            tooltipContainer.widthAnchor.constraint(lessThanOrEqualToConstant: 280),\n            tooltipContainer.centerXAnchor.constraint(equalTo: view.centerXAnchor)\n        ]\n        \n        if step.imageName != nil {\n            constraints.append(contentsOf: [\n                imageView.topAnchor.constraint(equalTo: tooltipContainer.topAnchor, constant: 16),\n                imageView.centerXAnchor.constraint(equalTo: tooltipContainer.centerXAnchor),\n                imageView.widthAnchor.constraint(equalToConstant: 32),\n                imageView.heightAnchor.constraint(equalToConstant: 32),\n                \n                titleLabel.topAnchor.constraint(equalTo: imageView.bottomAnchor, constant: 12)\n            ])\n        } else {\n            constraints.append(\n                titleLabel.topAnchor.constraint(equalTo: tooltipContainer.topAnchor, constant: 16)\n            )\n        }\n        \n        constraints.append(contentsOf: [\n            titleLabel.leadingAnchor.constraint(equalTo: tooltipContainer.leadingAnchor, constant: 16),\n            titleLabel.trailingAnchor.constraint(equalTo: tooltipContainer.trailingAnchor, constant: -16),\n            \n            descriptionLabel.topAnchor.constraint(equalTo: titleLabel.bottomAnchor, constant: 8),\n            descriptionLabel.leadingAnchor.constraint(equalTo: tooltipContainer.leadingAnchor, constant: 16),\n            descriptionLabel.trailingAnchor.constraint(equalTo: tooltipContainer.trailingAnchor, constant: -16),\n            \n            nextButton.topAnchor.constraint(equalTo: descriptionLabel.bottomAnchor, constant: 20),\n            nextButton.leadingAnchor.constraint(equalTo: tooltipContainer.leadingAnchor, constant: 16),\n            nextButton.trailingAnchor.constraint(equalTo: tooltipContainer.trailingAnchor, constant: -16),\n            nextButton.heightAnchor.constraint(equalToConstant: 44),\n            \n            skipButton.topAnchor.constraint(equalTo: nextButton.bottomAnchor, constant: 8),\n            skipButton.centerXAnchor.constraint(equalTo: tooltipContainer.centerXAnchor),\n            skipButton.bottomAnchor.constraint(equalTo: tooltipContainer.bottomAnchor, constant: -16)\n        ])\n        \n        NSLayoutConstraint.activate(constraints)\n    }\n    \n    private func positionTooltip() {\n        guard let targetView = step.targetView,\n              let window = view.window else {\n            // Center tooltip if no target\n            NSLayoutConstraint.activate([\n                tooltipContainer.centerYAnchor.constraint(equalTo: view.centerYAnchor)\n            ])\n            return\n        }\n        \n        let targetFrame = targetView.convert(targetView.bounds, to: window)\n        \n        switch step.position {\n        case .top:\n            NSLayoutConstraint.activate([\n                tooltipContainer.bottomAnchor.constraint(equalTo: view.topAnchor, constant: targetFrame.minY - 16)\n            ])\n        case .bottom:\n            NSLayoutConstraint.activate([\n                tooltipContainer.topAnchor.constraint(equalTo: view.topAnchor, constant: targetFrame.maxY + 16)\n            ])\n        case .left:\n            NSLayoutConstraint.activate([\n                tooltipContainer.trailingAnchor.constraint(equalTo: view.leadingAnchor, constant: targetFrame.minX - 16),\n                tooltipContainer.centerYAnchor.constraint(equalTo: view.topAnchor, constant: targetFrame.midY)\n            ])\n        case .right:\n            NSLayoutConstraint.activate([\n                tooltipContainer.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: targetFrame.maxX + 16),\n                tooltipContainer.centerYAnchor.constraint(equalTo: view.topAnchor, constant: targetFrame.midY)\n            ])\n        case .center:\n            NSLayoutConstraint.activate([\n                tooltipContainer.centerYAnchor.constraint(equalTo: view.centerYAnchor)\n            ])\n        }\n    }\n    \n    @objc private func nextTapped() {\n        UIView.animate(withDuration: 0.2, animations: {\n            self.view.alpha = 0\n        }) { _ in\n            self.onNext()\n        }\n    }\n    \n    @objc private func skipTapped() {\n        ContextualTourManager.shared.stopTour()\n    }\n    \n    @objc private func overlayTapped() {\n        // Allow tapping outside tooltip to continue\n        nextTapped()\n    }\n}\n\n// MARK: - Extensions for easy tour creation\nextension UIViewController {\n    /// Start a contextual tour highlighting specific elements\n    func startContextualTour(steps: [ContextualTourStep], completion: (() -> Void)? = nil) {\n        ContextualTourManager.shared.startTour(steps: steps, completion: completion)\n    }\n}