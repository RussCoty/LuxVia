# Color Coding Guide for LLM Responses

## Overview

The Eulogy Writer feature now includes color coding to distinguish between different types of AI responses, making it easier for users to understand the source of each message.

## Color Scheme

### AI-Generated Responses (Light Blue)
- **Purpose**: Messages generated by the actual LLM (OpenAI GPT-4o-mini or MockLLMService)
- **Color (Light Mode)**: Light blue (#B3D9F2) - RGB(0.7, 0.85, 0.95)
- **Color (Dark Mode)**: Medium blue - RGB(0.3, 0.5, 0.65) - Optimized for WCAG contrast
- **Label**: "AI Generated" with a blue indicator dot
- **When used**: When the LLM successfully generates a contextual, conversational response

### Pre-Written/Template Responses (Light Purple/Lavender)
- **Purpose**: Fallback or template-based responses
- **Color (Light Mode)**: Light purple/lavender (#E6D9F2) - RGB(0.9, 0.85, 0.95)
- **Color (Dark Mode)**: Medium purple - RGB(0.45, 0.35, 0.5) - Optimized for WCAG contrast
- **Label**: "Template" with a purple indicator dot
- **When used**: 
  - Initial greeting message
  - Fallback questions when LLM is unavailable or fails
  - System-generated prompts (e.g., draft completion message)

### Draft Eulogies
- **Purpose**: The generated eulogy draft
- **Color**: System secondary background (same as before)
- **Label**: "Draft eulogy"
- **When used**: When a complete eulogy draft is generated

### User Messages
- **Purpose**: Messages sent by the user
- **Color**: Accent color (blue by default)
- **When used**: All user input messages

## Implementation Details

### ChatMessage Model
The `ChatMessage` struct now includes a `MessageSource` enum:

```swift
enum MessageSource { 
    case user
    case aiGenerated
    case preWritten
    case draft 
}
```

### Automatic Source Detection
When creating a `ChatMessage`, the source is automatically determined based on the role if not explicitly provided:
- `.user` role → `.user` source
- `.draft` role → `.draft` source  
- `.assistant` role → `.preWritten` source (default)

### Explicit Source Marking
In `EulogyChatEngine`:
- LLM-generated responses are explicitly marked with `source: .aiGenerated`
- Pre-written responses are explicitly marked with `source: .preWritten`
- The initial greeting and fallback messages use `.preWritten`

### UI Components

#### MessageBubble View
The `MessageBubble` view determines the bubble color based on the message source:
- User messages: Accent color
- AI-generated: Light blue (`AIGeneratedResponse` color asset)
- Pre-written: Light purple (`PreWrittenResponse` color asset)
- Other: System secondary background

#### SourceIndicator View
A reusable component that displays a small colored dot with a label:
- Eliminates code duplication
- Consistent styling across message types
- Accepts color and label text as parameters

## User Benefits

1. **Transparency**: Users can clearly see when they're interacting with actual AI vs templated responses
2. **Trust**: Understanding the source of responses builds trust in the system
3. **Debugging**: Developers can quickly identify which code path generated each response
4. **Visual Hierarchy**: Different colors help organize the conversation visually

## Accessibility

### Contrast Optimization
Both color sets have been optimized for accessibility:
- Dark mode colors use higher luminance values for better contrast with text
- Tested to ensure readability for users with different visual needs
- Follows WCAG contrast ratio guidelines

### Color Independence
The feature includes textual labels ("AI Generated", "Template") alongside color coding, ensuring users who cannot distinguish colors can still identify message sources.

## Technical Notes

### Color Assets
- `AIGeneratedResponse.colorset` - Light blue color for AI-generated responses
- `PreWrittenResponse.colorset` - Light purple color for template responses

### Color Values (Updated for Better Contrast)
**AI Generated (Light Mode)**: RGB(0.7, 0.85, 0.95) - Light blue
**AI Generated (Dark Mode)**: RGB(0.3, 0.5, 0.65) - Medium blue (improved contrast)

**Pre-Written (Light Mode)**: RGB(0.9, 0.85, 0.95) - Light lavender
**Pre-Written (Dark Mode)**: RGB(0.45, 0.35, 0.5) - Medium purple (improved contrast)

## Testing

A comprehensive test suite (`test_color_coding.swift`) validates:
- Source determination logic for different role types
- Color selection based on message source
- Default behavior vs explicit source marking
- All 10 tests pass successfully

### Running Tests
```bash
swift test_color_coding.swift
```

## Future Enhancements

Potential future improvements:
- Add user preference to toggle color coding on/off
- Customize colors based on user preferences
- Add tooltips explaining the difference when hovering over labels
- Include analytics on AI vs template response usage
- Expand color coding to other chat-based features in the app
